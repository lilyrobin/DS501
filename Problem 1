import pandas as pd

#-------------------------------
# Your code goes here.
# Add as many cells as you need
#-------------------------------
# build a Dataframe of users'information and display it in table format
unames = ['user_id', 'gender', 'age', 'occupation', 'zip'] 
users = pd.read_table('/Users/Stefan/Downloads/ml-1m/users.dat', sep='::', header=None,names=unames)

#create a Dataframe of ratings'information and display it in table format
rnames = ['user_id', 'movie_id', 'rating', 'timestamp']
ratings = pd.read_table('/Users/Stefan/Downloads/ml-1m/ratings.dat', sep='::', header=None,names=rnames)

#create a Dataframe of movies'information and display it in table format
mnames = ['movie_id', 'title', 'genres']
movies = pd.read_table('/Users/Stefan/Downloads/ml-1m/movies.dat', sep='::', header=None,names=mnames)

#merge those 3 tables into one complete table
data= pd.merge(pd.merge(ratings,users),movies)

#store Data into HDF5 file
store=pd.HDFStore('data.h5')
data.to_hdf('data.h5','table',append=True)

#How many movies have an average rating over 4.5 overall?
mean_ratings =data.pivot_table('rating',rows='title',aggfunc='mean')
for i in range(3706):
    if(mean_ratings[i]>4.5):
        print mean_ratings.index[i]+' '+str(mean_ratings[i])

# How many movies have an average rating over 4.5 overall?

# Calculate the mean rating of each movie
meandf= data.groupby(['title'], as_index=False).aggregate({'rating':np.mean})
ratingdf = meandf[meandf['rating']>4.5]
print "\n Movies with average rating over 4.5"
print ratingdf.sort(['rating'], ascending=[0])

# How many movies have an average rating over 4.5 among men? How about women?
meandf= data.groupby(['title','gender'], as_index=False).aggregate({'rating':np.mean})

#Men
ratingMendf = meandf[(meandf['rating']>4.5)&(meandf['gender']=='M')]
print "\n Movies with average rating over 4.5 rated by Men"
print ratingMendf.sort(['rating'], ascending=[0])

#Women
ratingWomendf = meandf[(meandf['rating']>4.5)&(meandf['gender']=='F')]
print "\n Movies with average rating over 4.5 rated by Women"
print ratingWomendf.sort(['rating'], ascending=[0])
# How many movies have an median rating over 4.5 among men over age 30? How about women over age 30?
mediandf= data.groupby(['title','gender','age'], as_index=False).aggregate({'rating':np.median})

#Men
ratingMendf = mediandf[(mediandf['rating']>4.5)&(mediandf['gender']=='M')&(mediandf['age']>30)]
print "\n Movies with median rating over 4.5 rated by Men"
print ratingMendf.sort(['rating'], ascending=[0])

#Women
ratingWomendf = mediandf[(mediandf['rating']>4.5)&(mediandf['gender']=='F')&(mediandf['age']>30)]
print "\n Movies with median rating over 4.5 rated by Women"
print ratingWomendf.sort(['rating'], ascending=[0])
        
#What are ten most popular movies? we gonna count the number of rating by users because the more rating times there are,
#the more concentration the movie has which can serve to prove this movie is very popular
print "\n most rated:"
ratings_by_title = data.groupby('title').size()
ratings_by_title.sort(ascending=False)
#print ratings_by_title[:10]

#these are the movies with the highest number of ratings. but are they rated high? let's say among the top 100 movies by rating, the most popular are the 10 with the highest average rating

most_rated2 = ratings_by_title.head(n=100)
most_rated2 = most_rated2.index
high_pop=mean_ratings[most_rated2]
high_pop.sort(ascending=False)
print high_pop[:10]

#conjecture: look at most popular genres among different age groups 

#most popular genre
e=data.groupby('genres').size()
e.sort(ascending=False)
#print e
#most rated is comedy

#Conjectures: which is the most common movie style among middle aged people(40-60)? I guess Drama
print "\n most popular genre among middle aged:"
middle_age_data=data[(data.age>=40)&(data.age<=60)]
a=middle_age_data.groupby('genres').size()
a.sort(ascending=False)
print a[:10]
#yes, drama. 

#check all age blocks of 10 years
#kids
print "\n most common genre among kids:"
kids=data[(data.age<=9)]
f=kids.groupby('genres').size()
f.sort(ascending=False)
print f[:10]

#teens
print "\n most common genre among teens:"
teens=data[(data.age>=10)&(data.age<=19)]
b=teens.groupby('genres').size()
b.sort(ascending=False)
print b[:10]

#20's
print "\n most common genre among 20's:"
adults=data[(data.age>=20)&(data.age<=29)]
c=middle_age_data.groupby('genres').size()
c.sort(ascending=False)
print c[:10]

#30's
print "\n most common genre among 30's:"
old=data[(data.age>=30)&(data.age<=39)]
g=old.groupby('genres').size()
g.sort(ascending=False)
print g[:10]

#40's
print "\n most common genre among 40's:"
old=data[(data.age>=40)&(data.age<=49)]
g=old.groupby('genres').size()
g.sort(ascending=False)
print g[:10]

#50's
print "\n most common genre among 50's:"
old=data[(data.age>=50)&(data.age<=59)]
g=old.groupby('genres').size()
g.sort(ascending=False)
print g[:10]

#older adults
#print "\n most common genre among elderly:"
#old=data[(data.age>=61)]
#g=old.groupby('genres').size()
#g.sort(ascending=False)
#print g[:10]
